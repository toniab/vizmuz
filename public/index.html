<!DOCTYPE html>
<html>
<head>
    <title>VIZMUZ</title>
    <link rel="stylesheet" type="text/css" src="css/normalize.css">
    <meta name="viewport" content="width=device-width,
        initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <script src="lib/three.min.js"></script>
    <script src="lib/socket.io-1.1.0.js"></script>
    <script data-main="app/main" src="lib/require.js"></script>
    <script id="vertexShader" type="x-shader/x-vertex">
        uniform float time;
        uniform vec2 resolution;
        uniform sampler2D music_tex;
        uniform sampler2D face_tex;
        void main() {
            gl_Position = vec4(position, 1.0);
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        uniform float time;
        uniform vec2 resolution;
        uniform sampler2D music_tex;
        uniform sampler2D face_tex;
        const float PI = 3.1415926536;

        vec2 rose(float k, float t) {
            return vec2(cos(k*t)*cos(t), cos(k*t)*sin(t));
        }

        float linMap (float inputStart, float inputEnd, float outputStart, float outputEnd, float inputValue) {
            return (inputValue-inputStart)/(inputEnd - inputStart) * (outputEnd - outputStart) + outputStart;
        }

        float repeat (float val, float t) {
            return mod(val,t);
        }

        float pingPong (float val, float t) {
            return 2./PI * asin(sin(2.*PI/t*val));
        }

        vec4 screen (vec4 target, vec4 blend) {
            return 1. - (1.-target) * (1. - blend);
        }

        vec4 linearDodge (vec4 target, vec4 blend) {
            return target + blend;
        }

        // vec4 hardLight (vec4 target, vec4 blend) {
        //     if (blend < 0.5) {
        //         return 2.*target*blend;
        //     } else {
        //         return 1.-2.*(1.-blend)*(1.-target);
        //     }
        //     // return vec4(1.);//(blend > vec4(0.5))? (1.-(1.-target)*(1.-2.*(blend-.5))) : (target*(2.*blend));
        // }

        vec4 from255 (vec3 color) {
            return vec4(color/255.,1.);
        }


        void main() {

            vec2 pos = vec2(gl_FragCoord)/resolution;
            vec2 cartP = pos - vec2(.5,.5);
            float r = length(cartP);
            float theta = atan(cartP.y,cartP.x);

            float val = texture2D(music_tex, vec2(0./2.,1)).r;
            // r = r*r*((sin(time/5.)+1.)/2.+0.8);
            r = pow(r,time/1000.);//*time/100.;
            cartP = r * vec2(cos(theta),sin(theta));
            // gl_FragColor = texture2D(face_tex, cartP+.5);

            // gl_FragColor = vec4(linMap(-PI, PI, 0., 1., theta),0.,0.,1.);
            // gl_FragColor = vec4(linMap(-1., 1., 0., 1., sin(theta*time)),0.,0.,1.);
            // gl_FragColor = vec4(linMap(-1., 1., 0., 1., sin(theta*10.*time/10.+time/10.)),
            //                     0.,0.,1.);

            float beatDetect = texture2D(music_tex, vec2(0.2,1.)).r;
            vec4 pink = from255(vec3(255,144,222));
            vec4 blue = from255(vec3(147,144,255));
            if (beatDetect < 0.63) {
                // gl_FragColor = linearDodge(pink, linMap(-1., 1., 0., 1., sin(theta*10.*time/10.+time/10.)) * texture2D(face_tex, cartP+.5));
                gl_FragColor = linMap(-1., 1., 0., 1., sin(theta*10.*time/10.+time/10.)) * texture2D(face_tex, cartP+.5);
            } else {
                gl_FragColor = linearDodge(blue, linMap(-1., 1., 0., 1., sin(theta*10.*time/10.+time/10.)) * texture2D(face_tex, cartP+.5));
            }


            // gl_FragColor = vec4(pingPong(pos.x,0.1));



            // if (beatDetect < 0.63) {}


            // vec2 r = rose(5.,dist*10.);



            // gl_FragColor = texture2D(face_tex, pos);


            // float dist_from_face_center = dist_2d(pos,center);
            // gl_FragColor = vec4(dist_from_face_center,0,0,1);
            // gl_FragColor = texture2D(face_tex, (pos*2.)*(dist_from_face_center*2.));

            // gl_FragColor = texture2D(face_tex, pos);

            // float distortion = linMap (0., 0.70710, 0.5, 1., dist_from_face_center);

            // gl_FragColor = vec4( (pos)*(distortion)
            //                      //(center)//*(distortion)
            //                     ,0,1);

            // gl_FragColor = vec4( (center)+(distortion)
            //                     ,0,1);

            // gl_FragColor = vec4( (pos) ,0,1);

            // gl_FragColor = texture2D(face_tex, vec2(-1,-1));
            // gl_FragColor = vec4(pos.x,pos.y,0,1);

            // // vec4 color;

            // // color = texture2D( music_tex
            // //                  , vec2( pos.x
            // //                        , 1)
            // //                  );


            // // gl_FragColor = texture2D(music_tex, vec2(pos.x,1));
            // // gl_FragColor = texture2D(music_tex, vec2(sqrt(pos.x*pos.x + pos.y*pos.y),1));
            // vec2 delta = pos - vec2(0.25,0.25);
            // float val = texture2D(music_tex, vec2(pos.x,1)).r;
            // float dist = sqrt(dot(delta*val*5.,delta*val*5.));
            // // float dist = sqrt(dot(delta,delta));
            // float specVal = texture2D(music_tex, vec2(0.2,1.)).r;
            // vec2 r = rose(5.,dist*10.);
            // if (specVal < 0.63) {
            //     // gl_FragColor = texture2D(face_tex, (vec2(gl_FragCoord)/resolution*delta*2.+vec2(.5,.5)));
            //     float d = dist_2d((vec2(gl_FragCoord)/resolution), vec2(0.5,0.5)) * val;
            //     gl_FragColor = texture2D(face_tex, (vec2(gl_FragCoord)/resolution)*d);
            //     // gl_FragColor = vec4(val,r.x,r.y,1.);
            // } else {
            //     gl_FragColor = vec4(r.y,r.x,val,1.);
            // }
        }
    </script>

</head>
    <body>
        <div id="kick_test">kick</div>
        <div id="container"></div>
        <canvas id="canvas" width='512' height='512'></canvas>
    </body>
</html>